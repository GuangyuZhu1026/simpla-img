<link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../simpla-styles/simpla-styles.html"> <link rel="import" href="../iron-iconset-svg/iron-iconset-svg.html"> <link rel="import" href="../iron-icon/iron-icon.html" async> <link rel="import" href="../paper-slider/paper-slider.html" async> <iron-iconset-svg name="simpla-img"> <svg> <defs> <g id="camera-alt"><circle cx="12" cy="12" r="3.2"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></g> <g id="title"><path d="M5 4v3h5.5v12h3V7H19V4z"/></g> </defs> </svg> </iron-iconset-svg> <dom-module id="simpla-img-editor"> <template> <style>*,::after,::before,:host{box-sizing:border-box}:host{display:block;position:absolute;outline:0;font-size:var(--simpla-scale-0);z-index:var(--simpla-on-top);transition:box-shadow 130ms var(--simpla-easing-standard),transform .2s var(--simpla-easing-standard)}:host([hidden])){display:none}:host([visible]){box-shadow:var(--simpla-elevation-1)}.editor{position:relative;width:100%;height:100%;overflow:hidden;background:linear-gradient(45deg,rgba(0,0,0,.02) 25%,rgba(0,0,0,0) 25%,rgba(0,0,0,0) 75%,rgba(0,0,0,.02) 75%,rgba(0,0,0,.02) 0),linear-gradient(45deg,rgba(0,0,0,.02) 25%,rgba(0,0,0,0) 25%,rgba(0,0,0,0) 75%,rgba(0,0,0,.02) 75%,rgba(0,0,0,.02) 0),rgba(255,255,255,.02);background-position:0 0,.8em .8em;background-size:1.6em 1.6em}.cropper-view-box{outline:0}.cropper-face{opacity:0}.cropper-line,.cropper-point{display:none}.tools,.zoom{position:absolute;background:var(--simpla-bright-white);z-index:1;height:30px;transition:transform 130ms var(--simpla-easing-decelerate)}.tools{display:flex;align-items:center;top:0;right:7px;border-bottom-left-radius:var(--simpla-border-radius);border-bottom-right-radius:var(--simpla-border-radius);color:var(--simpla-grey-700)}.zoom{bottom:0;width:85%;left:0;right:0;margin:auto;border-top-left-radius:var(--simpla-border-radius);border-top-right-radius:var(--simpla-border-radius)}:host(:not([visible])) .tools,:host(:not([visible])) .zoom{transition-duration:60ms;transition-timing-function:var(--simpla-easing-accelerate)}:host(:not([visible])) .zoom{transform:translateY(100%)}:host(:not([visible])) .tools{transform:translateY(-100%)}.zoom__slider{width:100%;height:100%;cursor:pointer;--paper-slider-active-color:var(--simpla-primary-color);--paper-slider-container-color:var(--simpla-grey-500);--paper-slider-knob-color:var(--simpla-primary-color);--paper-slider-knob-start-color:transparent;--paper-slider-knob-start-border-color:var(--simpla-grey-700)}.zoom__disabled{display:block;text-align:center;font-size:var(--simpla-scale-000);color:var(--simpla-grey-700);padding:.5em 0;pointer-events:none}.tools__tool{display:inline-block;padding:5px 10px 7px;cursor:pointer}.tools__tool:hover,.tools__tool[data-active]{color:var(--simpla-primary-color)}.tools__tool__icon{--iron-icon-width:var(--simpla-scale-0);--iron-icon-height:var(--simpla-scale-0)}.title-input{font-family:var(--simpla-font-family);font-size:var(--simpla-scale-000);background:0 0;border:none;width:0;padding:0;outline:0;transition:width 150ms var(--simpla-easing-standard),padding-left 150ms var(--simpla-easing-standard)}.title-input::-webkit-input-placeholder{color:var(--simpla-grey-700)}.title-input:-ms-input-placeholder{color:var(--simpla-grey-700)}.title-input::placeholder{color:var(--simpla-grey-700)}.title-input[data-expanded]{width:80px;padding-left:1em}.editor-img{vertical-align:bottom;transform-origin:center;width:inherit;height:inherit;cursor:move}.editor-img[locked]{cursor:default}[hidden]{display:none!important}</style> <div class="editor"> <div class="tools" on-transitionend="_hideIfInactive"> <input type="text" id="title-input" class="title-input" placeholder="Enter a title" value="{{alt::input}}" data-expanded$="[[_titleOpen]]" on-blur="_toggleTitle"> <a class="tools__tool" on-tap="_toggleTitle" data-active$="[[_titleOpen]]"> <iron-icon class="tools__tool__icon" icon="simpla-img:title"> </iron-icon> </a> <a class="tools__tool" on-tap="openFilePicker"> <iron-icon class="tools__tool__icon" icon="simpla-img:camera-alt"> </iron-icon> <input type="file" id="file-input" on-change="_uploadImg" hidden> </a> </div> <img id="source" hidden="[[!src]]" class="editor-img" crossorigin="anonymous" src$="[[src]]" width$="[[width]]" height$="[[height]]" on-track="_dragImage" on-load="_imageLoaded" draggable="false" locked$="[[lockTransform]]"> <div class="zoom" on-transitionend="_hideIfInactive"> <paper-slider id="slider" class="zoom__slider" immediate-value="{{zoom}}" value="[[zoom]]" step="0.01" min="1" max="2" hidden$="[[lockTransform]]" no-ink=""> </paper-slider> <span class="zoom__disabled" hidden$="[[!lockTransform]]"> GIFs cannot be zoomed </span> </div> </div> </template> <script>!function(){"use strict";function t(t,e,i){var n=t.width,o=t.height,a=void 0;return a=Math.min(1,Math.min(e.width/n,e.height/o)),(a*n<i.width||a*o<i.height)&&(a=Math.max(i.width/n,i.height/o)),{width:Math.round(n*a),height:Math.round(o*a)}}function e(t,e,i){var n=t.top,o=t.left,a=t.width,r=t.height,s=o+a,h=n+r,c=0,u=0,l=void 0;return l={left:e.scrollX+i,top:e.scrollY+i,right:e.scrollX+e.innerWidth-i,bottom:e.scrollY+e.innerHeight-i},o<l.left?c=l.left-o:s>l.right&&(c=l.right-s),n<l.top?u=l.top-n:h>l.bottom&&(u=l.bottom-h),{translateY:u,translateX:c}}function i(i,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:s,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r,h=void 0,c=void 0,u=void 0,l=void 0,d=void 0;h={width:n.innerWidth-2*o,height:n.innerHeight-2*o};var f=t(i,h,a);c=f.width,u=f.height;var v=e({top:i.top,left:i.left,width:c,height:u},n,o);return l=v.translateX,d=v.translateY,{width:c,height:u,translateX:l,translateY:d}}function n(t,e){return t<e.min?e.min:t>e.max?e.max:t}function o(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=Math.pow(10,e);return Math.round(t*i)/i}var a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=",r={width:180,height:130},s=8,h={observers:["_fitIntoVisibleWindow(top, left, width, height, visible)"],_fitIntoVisibleWindow:function(t,e,n,o,a){var r=this;a||(this.style.transform=""),this.debounce("fit-to-window",function(){var a={top:t,left:e,width:n,height:o},s=void 0,h=void 0,c=void 0,u=i(a,window);n=u.width,o=u.height,s=u.translateX,h=u.translateY,r.width=n,r.height=o,r.style.transform="translate("+s+"px, "+h+"px)",(c=!(n===a.width&&o===a.height&&!s&&!h))&&r._closeOnScroll()})},_closeOnScroll:function(){var t=this,e=function e(){window.removeEventListener("scroll",e),t.active=!1};this.async(function(){return window.addEventListener("scroll",e)},100)}},c=[1,0,0,1,0,0],u=document.createElement("canvas"),l=u.getContext("2d"),d={properties:{output:{type:String,notify:!0},position:{type:Object,value:function(){return{x:0,y:0}},observer:"_positionChanged",notify:!0},debounceDuration:{type:Number,value:100},_transform:{type:String,value:""}},observers:["_updateStyles(_transform)","_debouncedRender(_transform, src)","_updatePosition(_transform)","_updateScale(zoom)"],attached:function(){this._localDOMReady&&this.setScrollDirection("all",this.$.source)},get _localDOMReady(){return!!this.$},_paint:function(){var t=this;this._tick&&(cancelAnimationFrame(this._tick),this._tick=null),this._tick=requestAnimationFrame(function(){var e=t.scale,i=t.translateX,n=t.translateY;t._transform="scale("+e+") translateX("+i+"px) translateY("+n+"px)"})},_updateScale:function(t){this.scale=t},get scale(){return this._scale||1},set scale(t){var e=this.minScale;this._scale=t<e?o(parseFloat(e),2):o(parseFloat(t),2),this.translateX+=0,this.translateY+=0,this._paint()},get translateX(){return this._translateX||0},set translateX(t){this._translateX=o(n(t,this._bounds.x)),this._paint()},get translateY(){return this._translateY||0},set translateY(t){this._translateY=o(n(t,this._bounds.y)),this._paint()},get minScale(){if(!this._localDOMReady)return 1;var t=this.height/this.$.source.height,e=this.width/this.$.source.width;return isNaN(t)||isNaN(e)?1:t<e?t:e},get _bounds(){var t=function(t){return{min:-t/2,max:t/2}},e=void 0,i=void 0;return this._imgWidth&&this._width&&this._imgHeight&&this._height?(e=this._imgWidth-this._width/this.scale,i=this._imgHeight-this._height/this.scale,{x:t(e),y:t(i)}):{x:{min:Number.NEGATIVE_INFINITY,max:Number.POSITIVE_INFINITY},y:{min:Number.NEGATIVE_INFINITY,max:Number.POSITIVE_INFINITY}}},_resetDimensions:function(){this._localDOMReady&&(this._width=this.offsetWidth,this._height=this.offsetHeight,this._imgWidth=this.$.source.offsetWidth,this._imgHeight=this.$.source.offsetHeight)},_dragImage:function(t){var e=t.detail,i=e.dx,n=e.dy,o=e.ddx,a=e.ddy,r=e.state;this.lockTransform||("start"===r&&this._resetDimensions(),this.translateX+=("start"===r?i:o)/this.scale,this.translateY+=("start"===r?n:a)/this.scale,"end"===r&&this.fire("pan-finished"))},_imageLoaded:function(){this._resetDimensions()},_positionChanged:function(t){if(t){var e=t.x,i=t.y;this.translateX=e,this.translateY=i}},_updatePosition:function(){this.position={x:this.translateX,y:this.translateY}},_updateStyles:function(t){this._localDOMReady&&(this.$.source.style.transform=t)},_debouncedRender:function(){var t=this._localDOMReady&&this.$.source.complete&&0!==this.$.source.naturalHeight;!this.lockTransform&&t&&this.debounce("render",this._render,this.debounceDuration)},_render:function(){if(this._localDOMReady){var t=this.width,e=this.height,i=this.scale,n=this.translateX,o=this.translateY,r=this.$.source,s=r.naturalWidth,h=r.naturalHeight,d=n/(t/s),f=o/(e/h),v=function(t){return t/i*(1-i)/2},g=void 0;u.width=s,u.height=h,l.setTransform.apply(l,c),l.scale(i,i),l.translate(d,f),l.drawImage(this.$.source,v(s),v(h)),g=u.toDataURL(),this.output=this.src===a?a:g}}},f={observers:["_stopEditingOnResize(active)"],listeners:{keyup:"_keyupHandler",blur:"_blurHandler"},_stopEditingOnResize:function(t){var e=this,i=function t(){window.removeEventListener("resize",t),e.active=!1};t&&window.addEventListener("resize",i)},_keyupHandler:function(t){var e=13===t.keyCode&&t.metaKey,i=27===t.keyCode;(e||i)&&(this.active=!1)},_blurHandler:function(t){var e=this,i=void 0;if(Polymer.Settings.useShadow)return void(this.active=!1);(i=function(t){var n=t.target,o=t.relatedTarget;o&&function(t){return e.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_CONTAINED_BY}(o)?o.addEventListener("blur",i):e!==o&&(e.active=!1),n.removeEventListener("blur",i)})(t)}},v=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},g=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),m=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},_=function(t){return{get:function(e){return t[e]},set:function(e,i){t[e]=i}}}({}),p={properties:{image:{type:Object,value:null}},observers:["_updateImageFromActive(active)","_updateActiveFromImage(image)","_maybeAskForFilePicker(image)","_updateImageData(output, alt)","_debouncedUpdateCache(src, alt, position, lockTransform, zoom)","_loadDataFromImage(active, image)","_resizeFromImage(image)"],listeners:{"opening-filepicker":"_restoreImageFocus","image-uploaded":"_updateImageSrc"},_resizeFromImage:function(t){t&&m(this,this._getImageBounds(t))},_loadDataFromImage:function(t,e){if(t&&e){var i=_.get(this._getImageKey(e))||{},n=i.src,o=i.alt,a=void 0===o?"":o,r=i.position,s=void 0===r?{x:0,y:0}:r,h=i.zoom,c=void 0===h?1:h,u=i.lockTransform,l=void 0!==u&&u,d=this._getImageData(e),f={alt:a,position:s,zoom:c};n&&(f.src=n),this._setLockTransform(l),m(this,d,f)}},_debouncedUpdateCache:function(t,e,i,n,o){var a=this.image;if(a){var r=this._getImageKey(a);this.debounce("set-cache-"+r,function(){_.set(r,{src:t,alt:e,position:i,lockTransform:n,zoom:o})})}},_updateImageFromActive:function(t){!t&&this.image&&this._closeImage(this.image)},_updateActiveFromImage:function(t){this.active=!!t},_updateImageData:function(t,e){this.image&&this._setImageData(this.image,{output:t,alt:e})},_restoreImageFocus:function(t){var e=this,i=this.image,n=void 0;n=function(){e.__restoringFocus=!0,e._editImage(i),e.__restoringFocus=!1,e.removeEventListener("blur",n)},this.addEventListener("blur",n)},_updateImageSrc:function(){var t=this,e=this.image,i=void 0;i=function(n){t._resizeFromImage(e),e.removeEventListener("load",i)},e.addEventListener("load",i),this._updateImageData(this.src,this.alt)},_getImageBounds:function(t){var e=t.getBoundingClientRect(),i=e.top,n=e.left,o=e.width,a=e.height,r=window,s=r.scrollX;return i+=r.scrollY,n+=s,{top:i,left:n,width:o,height:a}},_maybeAskForFilePicker:function(t){t&&t.src===a&&!this.__restoringFocus&&this.openFilePicker()},_getImageData:function(t){return{src:t.src,alt:t.alt}},_setImageData:function(t,e){var i=e.output,n=e.alt;m(t,{src:i,alt:n})},_closeImage:function(t){t.active=!1},_getImageKey:function(t){return t.path},_editImage:function(t){t.active=!0}},b=function(){function t(){v(this,t)}return g(t,[{key:"beforeRegister",value:function(){this.is="simpla-img-editor",this.properties={active:{type:Boolean,value:!1,notify:!0},visible:{type:Boolean,reflectToAttribute:!0,readonly:!0,value:!1},hidden:{type:Boolean,reflectToAttribute:!0,readonly:!0,value:!0},src:{type:String,notify:!0},alt:{type:String,notify:!0,value:""},zoom:{type:Number,notify:!0,value:1},position:{type:Object,value:function(){return{x:0,y:0}}},width:{type:Number,observer:"_observeWidth"},height:{type:Number,observer:"_observeHeight"},top:{type:Number,observer:"_observeTop",value:0},left:{type:Number,observer:"_observeLeft",value:0},output:{type:String,notify:!0},lockTransform:{type:Boolean,value:!1,readOnly:!0,reflectToAttribute:!0},_titleOpen:{type:Boolean,value:!1},tabindex:{type:Number,reflectToAttribute:!0,value:0}},this.observers=["_toggleVisibility(active)","_focusOnActive(active)"]}},{key:"openFilePicker",value:function(t){t&&t.stopPropagation(),this.fire("opening-filepicker"),this.$["file-input"].click()}},{key:"_observeWidth",value:function(t){this.style.width=t+"px"}},{key:"_observeHeight",value:function(t){this.style.height=t+"px"}},{key:"_observeLeft",value:function(t){this.style.left=t+"px"}},{key:"_observeTop",value:function(t){this.style.top=t+"px"}},{key:"_toggleVisibility",value:function(t){var e=this;t?(this.hidden=!1,Polymer.RenderStatus.afterNextRender(this,function(){return e.visible=!0})):this.visible=!1}},{key:"_hideIfInactive",value:function(t){this.active||(this.hidden=!0,this.visible=!1)}},{key:"_uploadImg",value:function(t){var e=this,i=t.target,n=i.files,o=new FileReader,a=function t(a){"image/gif"===n[0].type?(e.zoom=0,e.position={x:0,y:0},e._setLockTransform(!0)):e._setLockTransform(!1),e.src=a.target.result,e.fire("image-uploaded",{value:a.target.result}),o.removeEventListener("load",t),i.value=null};this.focus(),n&&n[0]&&(o.addEventListener("load",a),o.readAsDataURL(n[0]))}},{key:"focus",value:function(){var t=window,e=t.scrollY,i=t.scrollX;HTMLElement.prototype.focus.call(this),window.scrollTo(i,e)}},{key:"_toggleTitle",value:function(){this._titleOpen=!this._titleOpen}},{key:"_focusOnActive",value:function(t){var e=this;t&&this.async(function(){return e.focus()},0)}},{key:"behaviors",get:function(){return[h,d,f,p]}}]),t}();Polymer(b)}()</script> </dom-module> 